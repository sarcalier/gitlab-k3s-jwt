---
# Kubernetes Authentication Configuration
# Managed by Ansible - supports multiple OIDC issuers
apiVersion: apiserver.config.k8s.io/v1
kind: AuthenticationConfiguration
jwt:
  # GitLab OIDC issuer for CI/CD JWT tokens
  - issuer:
      url: {{ k3s_gitlab_url }}
{% if gitlab_ca_file_stat.stat.exists and gitlab_ca_verify.rc == 0 and gitlab_ca_file_content.content is defined and gitlab_ca_file_content.content != '' %}
      certificateAuthority: |
{% for line in (gitlab_ca_file_content.content | b64decode).splitlines() %}
        {{ line }}
{% endfor %}
{% endif %}
      audiences:
        - {{ k3s_gitlab_client_id }}
    claimValidationRules:
      - claim: iss
        requiredValue: {{ k3s_gitlab_url }}
    claimMappings:
      username:
        claim: {{ k3s_gitlab_username_claim }}
        prefix: "gitlab:"
      groups:
        claim: {{ k3s_gitlab_groups_claim }}
        prefix: "gitlab:"
  # Keycloak OIDC issuer for direct user authentication
  - issuer:
      url: {{ k3s_oidc_issuer_url }}
{% if keycloak_ca_file_stat.stat.exists and keycloak_ca_verify.rc == 0 and keycloak_ca_file.content is defined and keycloak_ca_file.content != '' %}
      certificateAuthority: |
{% for line in (keycloak_ca_file.content | b64decode).splitlines() %}
        {{ line }}
{% endfor %}
{% endif %}
      audiences:
        - {{ k3s_oidc_client_id }}
    claimValidationRules:
      - claim: iss
        requiredValue: {{ k3s_oidc_issuer_url }}
    claimMappings:
      username:
        claim: {{ k3s_oidc_username_claim }}
{% if k3s_oidc_username_prefix %}
        prefix: "{{ k3s_oidc_username_prefix }}"
{% else %}
        prefix: ""
{% endif %}
      groups:
        claim: {{ k3s_oidc_groups_claim }}
{% if k3s_oidc_groups_prefix %}
        prefix: "{{ k3s_oidc_groups_prefix }}"
{% else %}
        prefix: ""
{% endif %}
