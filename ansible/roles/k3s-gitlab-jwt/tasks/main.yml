---
# Configure k3s to accept GitLab CI_JOB_JWT for deployments

- name: Create k3s-gitlab-jwt config directory
  ansible.builtin.file:
    path: /etc/k3s-gitlab-jwt
    state: directory
    mode: "0755"
  become: true

- name: Get GitLab SSL certificate
  ansible.builtin.shell: |
    timeout 10 openssl s_client -showcerts -connect gitlab.gitlab.local:443 -servername gitlab.gitlab.local </dev/null 2>/dev/null | openssl x509 -outform PEM
  register: gitlab_cert
  changed_when: false
  failed_when: false
  become: true

- name: Save GitLab CA certificate to file
  ansible.builtin.copy:
    content: "{{ gitlab_cert.stdout }}"
    dest: /etc/k3s-gitlab-jwt/gitlab-ca.crt
    mode: "0644"
  become: true
  when: gitlab_cert.rc == 0 and gitlab_cert.stdout != ""
  register: gitlab_ca_file

- name: Read GitLab CA certificate for template
  ansible.builtin.slurp:
    src: /etc/k3s-gitlab-jwt/gitlab-ca.crt
  register: gitlab_ca_file_content
  become: true
  when: gitlab_ca_file is defined

- name: Check if GitLab CA certificate file exists
  ansible.builtin.stat:
    path: /etc/k3s-gitlab-jwt/gitlab-ca.crt
  register: gitlab_ca_file_stat
  become: true

- name: Verify GitLab CA certificate file format
  ansible.builtin.command:
    cmd: openssl x509 -in /etc/k3s-gitlab-jwt/gitlab-ca.crt -text -noout
  register: gitlab_ca_verify
  changed_when: false
  failed_when: false
  become: true
  when: gitlab_ca_file_stat.stat.exists

# Check current k3s configuration
- name: Read current k3s config
  ansible.builtin.slurp:
    src: /etc/rancher/k3s/config.yaml
  register: k3s_config_content
  become: true

- name: Check if GitLab OIDC already configured
  ansible.builtin.set_fact:
    gitlab_oidc_configured: "{{ k3s_gitlab_url in (k3s_config_content.content | b64decode) or 'authentication-config' in (k3s_config_content.content | b64decode) }}"

# Check for Keycloak CA certificate (from k3s-oidc role)
- name: Check if Keycloak CA certificate exists
  ansible.builtin.stat:
    path: /etc/k3s-oidc/keycloak-ca.crt
  register: keycloak_ca_file_stat
  become: true

- name: Read Keycloak CA certificate if exists
  ansible.builtin.slurp:
    src: /etc/k3s-oidc/keycloak-ca.crt
  register: keycloak_ca_file
  become: true
  when: keycloak_ca_file_stat.stat.exists

- name: Verify Keycloak CA certificate file format
  ansible.builtin.command:
    cmd: openssl x509 -in /etc/k3s-oidc/keycloak-ca.crt -text -noout
  register: keycloak_ca_verify
  changed_when: false
  failed_when: false
  become: true
  when: keycloak_ca_file_stat.stat.exists

# Create structured authentication configuration with multiple issuers
- name: Create structured authentication configuration
  ansible.builtin.template:
    src: authentication-config.yaml.j2
    dest: /etc/k3s-gitlab-jwt/authentication-config.yaml
    mode: "0600"
  become: true
  register: auth_config_template
  vars:
    gitlab_ca_file_content: "{{ gitlab_ca_file_content | default({'content': ''}) }}"
    keycloak_ca_file: "{{ keycloak_ca_file | default({'content': ''}) }}"

# Check if structured auth config is already in use
- name: Check if structured auth config is already configured
  ansible.builtin.set_fact:
    structured_auth_configured: "{{ 'authentication-config' in (k3s_config_content.content | b64decode) }}"

# Remove old OIDC command line arguments if structured auth is being configured
- name: Check for old OIDC flags in config
  ansible.builtin.set_fact:
    has_old_oidc_flags: "{{ 'oidc-issuer-url' in (k3s_config_content.content | b64decode) and 'authentication-config' not in (k3s_config_content.content | b64decode) }}"

- name: Remove old GitLab OIDC command line arguments
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-issuer-url={{ k3s_gitlab_url }}"$'
    replace: ''
  become: true
  register: remove_old_gitlab_issuer
  when: has_old_oidc_flags | default(false)

- name: Remove old GitLab OIDC client-id
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-client-id={{ k3s_gitlab_client_id }}"$'
    replace: ''
  become: true
  register: remove_old_gitlab_client
  when: has_old_oidc_flags | default(false)

- name: Remove old GitLab OIDC username-claim
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-username-claim={{ k3s_gitlab_username_claim }}"$'
    replace: ''
  become: true
  when: has_old_oidc_flags | default(false)

- name: Remove old GitLab OIDC groups-claim
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-groups-claim={{ k3s_gitlab_groups_claim }}"$'
    replace: ''
  become: true
  when: has_old_oidc_flags | default(false)

- name: Remove old GitLab OIDC username-prefix
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-username-prefix=gitlab:"$'
    replace: ''
  become: true
  when: has_old_oidc_flags | default(false)

- name: Remove old GitLab OIDC groups-prefix
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-groups-prefix=gitlab:"$'
    replace: ''
  become: true
  when: has_old_oidc_flags | default(false)

- name: Remove old GitLab OIDC required-claim
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-required-claim=iss:{{ k3s_gitlab_url }}"$'
    replace: ''
  become: true
  when: has_old_oidc_flags | default(false)

- name: Remove old GitLab OIDC CA file
  ansible.builtin.replace:
    path: /etc/rancher/k3s/config.yaml
    regexp: '^\s+- "oidc-ca-file=/etc/k3s-gitlab-jwt/gitlab-ca.crt"$'
    replace: ''
  become: true
  when: has_old_oidc_flags | default(false)

# Check if kube-apiserver-arg already exists in config
- name: Check if kube-apiserver-arg exists
  ansible.builtin.set_fact:
    kube_apiserver_arg_exists: "{{ 'kube-apiserver-arg' in (k3s_config_content.content | b64decode) }}"

# Add structured authentication config to k3s config
- name: Add authentication-config to existing kube-apiserver-arg
  ansible.builtin.lineinfile:
    path: /etc/rancher/k3s/config.yaml
    line: '  - "authentication-config=/etc/k3s-gitlab-jwt/authentication-config.yaml"'
    insertafter: 'kube-apiserver-arg:'
    state: present
    regexp: '^\s+- "authentication-config='
  become: true
  register: k3s_auth_config_added
  notify: Restart k3s
  when: 
    - kube_apiserver_arg_exists | default(false)
    - not structured_auth_configured | default(false)

- name: Add structured authentication config block to k3s config
  ansible.builtin.blockinfile:
    path: /etc/rancher/k3s/config.yaml
    block: |
      # Structured Authentication Configuration (multiple OIDC issuers)
      # Supports both GitLab CI_JOB_JWT and Keycloak direct authentication
      kube-apiserver-arg:
        - "authentication-config=/etc/k3s-gitlab-jwt/authentication-config.yaml"
    marker: "# {mark} ANSIBLE MANAGED STRUCTURED AUTH CONFIG"
    insertafter: EOF
  become: true
  register: k3s_auth_config_updated
  notify: Restart k3s
  when: 
    - not kube_apiserver_arg_exists | default(false)
    - not structured_auth_configured | default(false)

# Verify authentication config file syntax
- name: Validate authentication config YAML syntax
  ansible.builtin.command:
    cmd: python3 -c "import yaml; yaml.safe_load(open('/etc/k3s-gitlab-jwt/authentication-config.yaml'))"
  register: auth_config_validate
  changed_when: false
  failed_when: false
  become: true
  when: auth_config_template is changed

- name: Restart k3s if authentication config changed
  ansible.builtin.meta: flush_handlers
  when: 
    - auth_config_template is changed or
      k3s_auth_config_updated is changed or
      k3s_auth_config_added is changed or
      remove_old_gitlab_issuer is changed or
      remove_old_gitlab_client is changed

- name: Wait for k3s API server to be ready
  ansible.builtin.command:
    cmd: kubectl get nodes
  register: k3s_ready
  until: k3s_ready.rc == 0
  retries: 30
  delay: 10
  changed_when: false
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Test if k3s can access GitLab JWKS endpoint
  ansible.builtin.command:
    cmd: curl -k -s "{{ k3s_gitlab_url }}/oauth/discovery/keys" | head -c 200
  register: gitlab_jwks_test
  changed_when: false
  failed_when: false
  become: true

- name: Display GitLab JWKS accessibility
  ansible.builtin.debug:
    msg: "GitLab JWKS endpoint: {{ 'accessible' if 'keys' in gitlab_jwks_test.stdout else 'NOT accessible - ' + gitlab_jwks_test.stdout[:100] }}"

# Create RBAC resources
- name: Create GitLab RBAC manifest
  ansible.builtin.template:
    src: gitlab-rbac.yaml.j2
    dest: /etc/k3s-gitlab-jwt/gitlab-rbac.yaml
    mode: "0644"
  become: true
  register: gitlab_rbac_template

- name: Apply GitLab RBAC resources
  ansible.builtin.command:
    cmd: kubectl apply -f /etc/k3s-gitlab-jwt/gitlab-rbac.yaml
  register: apply_gitlab_rbac
  changed_when: "'created' in apply_gitlab_rbac.stdout or 'configured' in apply_gitlab_rbac.stdout"
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

# Generate GitLab CI template
- name: Generate GitLab CI JWT template
  ansible.builtin.template:
    src: gitlab-ci-jwt.yml.j2
    dest: /etc/k3s-gitlab-jwt/gitlab-ci-jwt.yml
    mode: "0644"
  become: true

# Update GitLab OIDC to sync groups
- name: Check current GitLab OIDC secret
  ansible.builtin.command:
    cmd: kubectl get secret gitlab-keycloak-oidc -n gitlab -o jsonpath='{.data.provider}'
  register: gitlab_oidc_secret
  changed_when: false
  failed_when: false
  become: true
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Display integration status
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "k3s Multi-Issuer OIDC Integration Complete"
      - "============================================"
      - ""
      - "Authentication Configuration:"
      - "  Type: Structured (multiple issuers)"
      - "  Config File: /etc/k3s-gitlab-jwt/authentication-config.yaml"
      - ""
      - "Issuer 1 - GitLab (CI/CD JWT):"
      - "  URL: {{ k3s_gitlab_url }}"
      - "  Client ID: {{ k3s_gitlab_client_id }}"
      - "  Username Claim: {{ k3s_gitlab_username_claim }}"
      - "  Groups Claim: {{ k3s_gitlab_groups_claim }}"
      - "  Prefix: gitlab:"
      - ""
      - "Issuer 2 - Keycloak (Direct Auth):"
      - "  URL: {{ k3s_oidc_issuer_url }}"
      - "  Client ID: {{ k3s_oidc_client_id }}"
      - "  Username Claim: {{ k3s_oidc_username_claim }}"
      - "  Groups Claim: {{ k3s_oidc_groups_claim }}"
      - "  Username Prefix: {{ k3s_oidc_username_prefix if k3s_oidc_username_prefix else '(none)' }}"
      - "  Groups Prefix: {{ k3s_oidc_groups_prefix if k3s_oidc_groups_prefix else '(none)' }}"
      - ""
      - "RBAC:"
      - "  Namespace: {{ k3s_gitlab_deploy_namespace }}"
      - "  Role: {{ k3s_gitlab_deployer_role }}"
      - "  Group: gitlab:{{ k3s_gitlab_deployer_group }}"
      - ""
      - "GitLab CI Template:"
      - "  Location: /etc/k3s-gitlab-jwt/gitlab-ci-jwt.yml"
      - ""
      - "============================================"
      - "Testing:"
      - "============================================"
      - ""
      - "# Check authentication config:"
      - "  ssh {{ ansible_host }} 'sudo cat /etc/k3s-gitlab-jwt/authentication-config.yaml'"
      - ""
      - "# Check k3s config:"
      - "  ssh {{ ansible_host }} 'sudo grep authentication-config /etc/rancher/k3s/config.yaml'"
      - ""
      - "# Test GitLab JWT (in pipeline):"
      - '  kubectl auth whoami --token=$KUBE_TOKEN'
      - ""
      - "# Test Keycloak token:"
      - '  kubectl auth whoami --token=$KEYCLOAK_TOKEN'
