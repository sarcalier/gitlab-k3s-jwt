# Keycloakx Helm values - configured for single-node k3s with PostgreSQL
# Managed by Ansible

# Replicas
replicas: {{ keycloak_replicas }}

# Image configuration (uses official Keycloak image from quay.io)
image:
  repository: quay.io/keycloak/keycloak
  tag: "26.5.0"
  pullPolicy: IfNotPresent

# Command to start Keycloak (builds on first start, then runs)
command:
  - "/opt/keycloak/bin/kc.sh"
  - "start"
  - "--db=postgres"

# Extra environment variables
# KC_HOSTNAME must include scheme (https://) for correct issuer in JWT tokens
extraEnv: |
  - name: KEYCLOAK_ADMIN
    value: {{ keycloak_admin_user }}
  - name: KEYCLOAK_ADMIN_PASSWORD
    value: {{ keycloak_admin_password }}
  - name: KC_PROXY
    value: edge
  - name: KC_HOSTNAME
    value: "https://{{ keycloak_domain }}"
  - name: KC_HOSTNAME_STRICT
    value: "false"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HEALTH_ENABLED
    value: "true"
  - name: KC_METRICS_ENABLED
    value: "true"

# Database configuration
database:
  vendor: {{ keycloak_db_vendor }}
  hostname: {{ keycloak_db_host }}
  port: {{ keycloak_db_port }}
  database: {{ keycloak_db_name }}
  username: {{ keycloak_db_user }}
  password: {{ keycloak_db_password }}

# Database checker - wait for PostgreSQL to be ready
dbchecker:
  enabled: true
  image:
    repository: docker.io/busybox
    tag: "1.36"
    pullPolicy: IfNotPresent

{% if keycloak_minimal_resources %}
# Resource limits for minimal deployment
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2
    memory: 1536Mi
{% endif %}

# HTTP settings
http:
  relativePath: {{ keycloak_http_relative_path }}

# Service configuration
service:
  type: ClusterIP
  httpPort: 80
  httpsPort: 8443

# Ingress configuration
ingress:
  enabled: {{ keycloak_ingress_enabled | lower }}
  ingressClassName: {{ keycloak_ingress_class }}
  annotations:
    kubernetes.io/ingress.class: {{ keycloak_ingress_class }}
{% if keycloak_ingress_class == 'traefik' %}
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
{% endif %}
  rules:
    - host: {{ keycloak_domain }}
      paths:
        - path: {{ keycloak_http_relative_path }}
          pathType: Prefix
  tls: []

# Disable pod anti-affinity for single-node deployment
affinity: ""

# Security context
podSecurityContext:
  fsGroup: 1000

securityContext:
  runAsUser: 1000
  runAsNonRoot: true

# Cache configuration for single instance
cache:
  stack: default
