---
# GitLab OIDC Provider Secret for Keycloak
# Managed by Ansible
apiVersion: v1
kind: Secret
metadata:
  name: {{ gitlab_oidc_secret_name }}
  namespace: {{ gitlab_oidc_namespace }}
type: Opaque
stringData:
  provider: |
    {
      "name": "{{ gitlab_oidc_provider_name }}",
      "label": "{{ gitlab_oidc_provider_label }}",
      "args": {
        "name": "{{ gitlab_oidc_provider_name }}",
        "scope": {{ gitlab_oidc_scopes | to_json }},
        "response_type": "code",
        "issuer": "{{ gitlab_oidc_keycloak_url }}/realms/{{ gitlab_oidc_realm }}",
        "discovery": false,
        "client_auth_method": "query",
        "uid_field": "{{ gitlab_oidc_uid_field }}",
        "pkce": true,
        "sync_profile_from_provider": {{ gitlab_oidc_sync_profile | default(true) | lower }},
        "sync_profile_attributes": {{ gitlab_oidc_sync_profile_attributes | default(["email", "name"]) | to_json }},
        "groups_attribute": "groups",
        "required_groups": [],
        "groups_attribute_path": "groups",
        "verify_ssl": false,
        "client_options": {
          "identifier": "{{ gitlab_oidc_client_id }}",
          "secret": "{{ gitlab_oidc_client_secret }}",
          "redirect_uri": "https://{{ gitlab_oidc_domain }}/users/auth/{{ gitlab_oidc_provider_name }}/callback",
          "scheme": "http",
          "host": "keycloak.local",
          "port": 80,
          "authorization_endpoint": "{{ gitlab_oidc_keycloak_internal_url }}/realms/{{ gitlab_oidc_realm }}/protocol/openid-connect/auth",
          "token_endpoint": "{{ gitlab_oidc_keycloak_internal_url }}/realms/{{ gitlab_oidc_realm }}/protocol/openid-connect/token",
          "userinfo_endpoint": "{{ gitlab_oidc_keycloak_internal_url }}/realms/{{ gitlab_oidc_realm }}/protocol/openid-connect/userinfo",
          "jwks_uri": "{{ gitlab_oidc_keycloak_internal_url }}/realms/{{ gitlab_oidc_realm }}/protocol/openid-connect/certs",
          "end_session_endpoint": "{{ gitlab_oidc_keycloak_internal_url }}/realms/{{ gitlab_oidc_realm }}/protocol/openid-connect/logout"
        }
      }
    }
