# GitLab OIDC Configuration for Keycloak
# Generated by Ansible
# Use this configuration in GitLab's gitlab.rb or Helm values

keycloak:
  realm: {{ keycloak_realm_name }}
  issuer_url: {{ keycloak_url }}/realms/{{ keycloak_realm_name }}

gitlab_oidc:
  name: keycloak
  label: "Login with Keycloak"
  icon: https://www.keycloak.org/resources/images/keycloak_icon_64px.svg
  
  # Client credentials
  app_id: {{ keycloak_gitlab_client_id }}
  app_secret: {{ keycloak_gitlab_client_secret }}
  
  # OIDC endpoints
  issuer: {{ keycloak_url }}/realms/{{ keycloak_realm_name }}
  discovery: true
  
  # Token configuration  
  client_options:
    site: {{ keycloak_url }}
    authorize_url: /realms/{{ keycloak_realm_name }}/protocol/openid-connect/auth
    user_info_url: /realms/{{ keycloak_realm_name }}/protocol/openid-connect/userinfo
    token_url: /realms/{{ keycloak_realm_name }}/protocol/openid-connect/token
    jwks_uri: /realms/{{ keycloak_realm_name }}/protocol/openid-connect/certs
  
  # Scopes
  scope:
    - openid
    - profile
    - email

  # Claim mappings
  args:
    uid_field: preferred_username
    name: name
    email: email
    groups: groups

# GitLab Helm values (omniauth configuration)
gitlab_helm_values: |
  global:
    appConfig:
      omniauth:
        enabled: true
        allowSingleSignOn:
          - openid_connect
        syncProfileFromProvider:
          - openid_connect
        syncProfileAttributes:
          - email
        blockAutoCreatedUsers: false
        providers:
          - secret: gitlab-keycloak-oidc
            key: provider

# Kubernetes secret for GitLab
gitlab_oidc_secret: |
  apiVersion: v1
  kind: Secret
  metadata:
    name: gitlab-keycloak-oidc
    namespace: gitlab
  type: Opaque
  stringData:
    provider: |
      {
        "name": "openid_connect",
        "label": "Keycloak",
        "args": {
          "name": "openid_connect",
          "scope": ["openid", "profile", "email"],
          "response_type": "code",
          "issuer": "{{ keycloak_url }}/realms/{{ keycloak_realm_name }}",
          "discovery": true,
          "client_auth_method": "query",
          "uid_field": "preferred_username",
          "client_options": {
            "identifier": "{{ keycloak_gitlab_client_id }}",
            "secret": "{{ keycloak_gitlab_client_secret }}",
            "redirect_uri": "https://gitlab.local/users/auth/openid_connect/callback"
          }
        }
      }

# Test user credentials
test_user:
  username: {{ keycloak_test_user_username }}
  password: {{ keycloak_test_user_password }}
  email: {{ keycloak_test_user_email }}
